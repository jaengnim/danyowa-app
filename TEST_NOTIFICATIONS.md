# 알림 테스트 가이드

## 🧪 단계별 테스트 방법

### 준비 단계

1. **개발 서버 실행**
   ```bash
   npm run dev
   ```
   또는
   ```bash
   npm start
   ```

2. **브라우저에서 앱 열기**
   - 데스크톱: `http://localhost:3000` (또는 개발 서버 주소)
   - 모바일: 같은 네트워크에서 모바일 브라우저로 접속

### 테스트 1: Service Worker 등록 확인

**목적**: Service Worker가 제대로 등록되고 활성화되었는지 확인

**방법**:
1. 브라우저 개발자 도구 열기 (F12)
2. **Application** 탭 (Chrome) 또는 **Storage** 탭 (Firefox) 클릭
3. 왼쪽 메뉴에서 **Service Workers** 클릭
4. 확인 사항:
   - ✅ `/service-worker.js`가 등록되어 있음
   - ✅ 상태가 **activated** 또는 **running**
   - ✅ Scope가 `/`로 설정되어 있음

**문제 해결**:
- Service Worker가 없다면: 페이지를 새로고침 (Ctrl+R 또는 Cmd+R)
- "waiting" 상태라면: "skipWaiting" 버튼 클릭 또는 페이지 새로고침
- 에러가 있다면: Console 탭에서 에러 메시지 확인

### 테스트 2: 알림 권한 요청

**목적**: 브라우저에서 알림 권한이 허용되었는지 확인

**방법**:
1. 앱에서 **"알림 켜기"** 버튼 클릭
2. 브라우저 알림 권한 팝업에서 **"허용"** 클릭
3. 확인 사항:
   - ✅ 브라우저 주소창에 알림 아이콘(🔔)이 표시됨
   - ✅ 앱에서 "테스트 알림 보내기" 버튼이 활성화됨

**문제 해결**:
- 권한이 거부되었다면:
  - Chrome: 주소창 왼쪽의 자물쇠 아이콘 클릭 > 알림 > 허용
  - Firefox: 주소창 왼쪽의 정보 아이콘 클릭 > 권한 > 알림 > 허용
  - Safari: 설정 > Safari > 웹사이트 설정 > 알림

### 테스트 3: Push 구독 확인

**목적**: Push 구독이 생성되고 서버에 등록되었는지 확인

**방법**:
1. 개발자 도구 > Application > Service Workers
2. 등록된 Service Worker 클릭
3. **Push** 섹션 확인
4. 확인 사항:
   - ✅ **Endpoint** URL이 있음 (예: `https://fcm.googleapis.com/...`)
   - ✅ **Keys** (p256dh, auth)가 있음

**또는 코드로 확인**:
브라우저 Console에서:
```javascript
navigator.serviceWorker.ready.then(reg => {
  reg.pushManager.getSubscription().then(sub => {
    console.log('Subscription:', sub);
    if (sub) {
      console.log('Endpoint:', sub.endpoint);
      console.log('Keys:', sub.getKey('p256dh'), sub.getKey('auth'));
    }
  });
});
```

### 테스트 4: 포그라운드 알림 테스트

**목적**: 앱이 열려있을 때 알림이 작동하는지 확인

**방법**:
1. 앱이 열려있는 상태 유지
2. **"테스트 알림 보내기"** 버튼 클릭
3. 확인 사항:
   - ✅ 알림이 즉시 표시됨
   - ✅ 알림 제목과 내용이 올바름
   - ✅ 알림 아이콘이 표시됨

### 테스트 5: 백그라운드 알림 테스트

**목적**: 앱이 백그라운드에 있을 때 알림이 작동하는지 확인

**방법 A: 다른 탭으로 이동**
1. 앱이 열려있는 상태에서 다른 탭으로 이동
2. **"테스트 알림 보내기"** 버튼 클릭 (또는 다른 기기에서)
3. 확인 사항:
   - ✅ 알림이 표시됨
   - ✅ 알림 클릭 시 앱 탭이 포커스됨

**방법 B: 앱 최소화 (모바일)**
1. 모바일에서 앱을 백그라운드로 보냄 (홈 버튼 누르기)
2. 다른 기기나 서버에서 알림 전송
3. 확인 사항:
   - ✅ 알림이 표시됨
   - ✅ 알림 클릭 시 앱이 열림

### 테스트 6: 완전 종료 상태 알림 테스트

**목적**: 앱이 완전히 종료되었을 때 알림이 작동하는지 확인

**방법**:
1. 브라우저를 완전히 종료 (모든 탭 닫기)
2. 서버에서 알림 전송:
   ```bash
   # API를 통해 알림 전송
   curl -X POST http://localhost:3000/api/send-notification \
     -H "Content-Type: application/json" \
     -d '{
       "subscription": {구독_정보},
       "title": "종료 상태 테스트",
       "body": "앱이 종료되어도 알림이 왔습니다!"
     }'
   ```
3. 확인 사항:
   - ✅ 알림이 표시됨
   - ✅ 알림 클릭 시 브라우저가 열리고 앱이 로드됨

### 테스트 7: 모바일 화면 꺼짐 상태 테스트

**목적**: 모바일에서 화면이 꺼져있을 때 알림이 작동하는지 확인

**방법**:
1. 모바일에서 앱을 열고 알림 권한 허용
2. 화면을 끔 (전원 버튼 누르기)
3. 서버에서 알림 전송
4. 확인 사항:
   - ✅ 알림이 표시됨
   - ✅ 알림 클릭 시 화면이 켜지고 앱이 열림

### 테스트 8: Cron 작업 알림 테스트

**목적**: 자동 스케줄 알림이 작동하는지 확인

**방법**:
1. 앱에서 일정을 추가하고 알림 시간 설정
2. 알림 시간이 되면 자동으로 알림이 전송됨
3. 확인 사항:
   - ✅ 설정한 시간에 알림이 표시됨
   - ✅ 알림 내용이 올바름

## 🔍 디버깅 팁

### 로그 확인

1. **Service Worker 로그**
   - 개발자 도구 > Application > Service Workers
   - Service Worker 클릭 > "Console" 탭 확인

2. **브라우저 Console 로그**
   - 개발자 도구 > Console 탭
   - 알림 관련 에러 메시지 확인

3. **네트워크 로그**
   - 개발자 도구 > Network 탭
   - `/api/subscribe` 및 `/api/send-notification` 요청 확인

### 일반적인 문제

**문제**: 알림이 오지 않음
- ✅ Service Worker가 활성화되어 있는지 확인
- ✅ 알림 권한이 허용되어 있는지 확인
- ✅ Push 구독이 생성되었는지 확인
- ✅ 서버에서 알림 전송 시 에러가 없는지 확인

**문제**: 알림은 오지만 클릭해도 앱이 열리지 않음
- ✅ Service Worker의 `notificationclick` 이벤트 핸들러 확인
- ✅ 알림의 `data.url`이 올바른지 확인

**문제**: 모바일에서 알림이 오지 않음
- ✅ 모바일 브라우저에서 알림 권한 확인
- ✅ 배터리 최적화 설정 확인
- ✅ PWA로 설치했는지 확인

## 📱 모바일 특별 설정

### Android Chrome

1. **배터리 최적화 해제**
   - 설정 > 앱 > Chrome > 배터리 > 배터리 최적화 해제

2. **백그라운드 데이터 허용**
   - 설정 > 앱 > Chrome > 데이터 사용량 > 백그라운드 데이터 허용

3. **PWA로 설치**
   - Chrome 메뉴 > "홈 화면에 추가"

### iOS Safari

1. **백그라운드 새로고침 활성화**
   - 설정 > Safari > 고급 > JavaScript 활성화
   - 설정 > Safari > 백그라운드 앱 새로고침 활성화

2. **PWA로 설치**
   - Safari 공유 버튼 > "홈 화면에 추가"

## ✅ 성공 기준

다음 모든 테스트가 통과하면 성공입니다:

- [ ] Service Worker가 등록되고 활성화됨
- [ ] 알림 권한이 허용됨
- [ ] Push 구독이 생성되고 서버에 등록됨
- [ ] 앱이 열려있을 때 알림이 표시됨
- [ ] 앱이 백그라운드에 있을 때 알림이 표시됨
- [ ] 앱이 완전히 종료되었을 때 알림이 표시됨
- [ ] 알림 클릭 시 앱이 열림
- [ ] (모바일) 화면이 꺼져있을 때 알림이 표시됨

