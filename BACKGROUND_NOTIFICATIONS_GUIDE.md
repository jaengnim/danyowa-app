# 백그라운드 알림 설정 가이드

## 📱 앱이 종료되거나 백그라운드에 있어도 알림을 받으려면?

### 1단계: Service Worker 확인

Service Worker는 브라우저가 백그라운드에서 실행하는 스크립트입니다. 앱이 닫혀도 Service Worker가 실행되어 알림을 받을 수 있습니다.

**확인 방법:**
1. 브라우저에서 앱을 엽니다
2. 개발자 도구(F12)를 엽니다
3. **Application** 탭(Chrome) 또는 **Storage** 탭(Firefox)으로 이동
4. 왼쪽 메뉴에서 **Service Workers** 클릭
5. `/service-worker.js`가 등록되어 있고 **activated** 상태인지 확인

**문제 해결:**
- Service Worker가 없다면: 페이지를 새로고침하세요
- Service Worker가 "waiting" 상태라면: "skipWaiting" 버튼을 클릭하거나 페이지를 새로고침하세요

### 2단계: 알림 권한 허용

**데스크톱 브라우저:**
1. 앱에서 "알림 켜기" 버튼 클릭
2. 브라우저에서 알림 권한 요청 팝업이 나타나면 **허용** 클릭

**모바일 브라우저 (Android Chrome):**
1. 앱에서 "알림 켜기" 버튼 클릭
2. 알림 권한 요청 팝업에서 **허용** 클릭
3. 설정 > 사이트 설정 > 알림에서도 확인 가능

**모바일 브라우저 (iOS Safari):**
1. Safari에서 앱을 열고 공유 버튼 클릭
2. "홈 화면에 추가" 선택 (PWA 설치)
3. 홈 화면에서 앱 실행
4. 알림 권한 요청 시 허용

### 3단계: Push 구독 확인

알림 권한을 허용한 후, 앱이 자동으로 Push 구독을 생성하고 서버에 등록합니다.

**확인 방법:**
1. 개발자 도구 > Application > Service Workers
2. 등록된 Service Worker 클릭
3. "Push" 섹션에서 구독 정보 확인
4. "Endpoint" URL이 있는지 확인

### 4단계: 테스트

**방법 1: 앱 내에서 테스트**
1. 앱이 열려있는 상태에서 "테스트 알림 보내기" 버튼 클릭
2. 알림이 나타나는지 확인

**방법 2: 백그라운드 테스트**
1. 앱을 백그라운드로 보냅니다 (다른 탭으로 이동 또는 앱 최소화)
2. 다른 기기나 브라우저에서 다음 API 호출:
   ```bash
   curl -X POST http://localhost:3000/api/send-notification \
     -H "Content-Type: application/json" \
     -d '{
       "subscription": {여기에_구독_정보},
       "title": "테스트 알림",
       "body": "백그라운드에서도 작동합니다!"
     }'
   ```
3. 알림이 나타나는지 확인

**방법 3: 완전 종료 테스트**
1. 브라우저를 완전히 종료합니다
2. 서버에서 cron 작업이 실행되거나 API를 통해 알림을 보냅니다
3. 알림이 나타나는지 확인

### 5단계: 모바일에서 PWA 설치 (선택사항, 권장)

**Android:**
1. Chrome에서 앱 열기
2. 주소창 옆 메뉴(⋮) 클릭
3. "홈 화면에 추가" 또는 "앱 설치" 선택
4. 설치된 앱 아이콘으로 실행

**iOS:**
1. Safari에서 앱 열기
2. 공유 버튼(□↑) 클릭
3. "홈 화면에 추가" 선택
4. 설치된 앱 아이콘으로 실행

**왜 PWA 설치가 중요한가?**
- 설치된 PWA는 독립적인 앱처럼 작동
- 백그라운드 알림이 더 안정적으로 작동
- 앱 아이콘이 홈 화면에 표시됨

## 🔧 문제 해결

### 알림이 오지 않는 경우

1. **Service Worker 확인**
   - Application 탭에서 Service Worker가 활성화되어 있는지 확인
   - Service Worker를 Unregister 후 페이지 새로고침

2. **알림 권한 확인**
   - 브라우저 설정에서 알림 권한이 허용되어 있는지 확인
   - Chrome: 설정 > 사이트 설정 > 알림
   - Firefox: 설정 > 개인정보 보호 및 보안 > 권한 > 알림

3. **Push 구독 확인**
   - 개발자 도구에서 Push 구독이 있는지 확인
   - 구독이 없다면 "알림 켜기" 버튼을 다시 클릭

4. **서버 로그 확인**
   - 서버에서 알림 전송 시 에러가 있는지 확인
   - VAPID 키가 올바르게 설정되어 있는지 확인

5. **브라우저 호환성**
   - Chrome, Edge, Firefox 최신 버전 사용 권장
   - Safari는 iOS 16.4 이상에서만 지원

### 모바일에서 알림이 오지 않는 경우

1. **배터리 최적화 비활성화**
   - Android: 설정 > 앱 > Chrome > 배터리 > 배터리 최적화 해제
   - iOS: 설정 > Safari > 백그라운드 앱 새로고침 활성화

2. **브라우저가 백그라운드에서 실행되도록 설정**
   - Android: Chrome이 백그라운드에서 실행되도록 허용
   - iOS: Safari 백그라운드 새로고침 활성화

3. **PWA로 설치**
   - 홈 화면에 추가하여 PWA로 설치하면 더 안정적

## 📋 체크리스트

백그라운드 알림이 작동하려면:

- [ ] Service Worker가 등록되고 활성화됨
- [ ] 알림 권한이 허용됨
- [ ] Push 구독이 생성되고 서버에 등록됨
- [ ] VAPID 키가 올바르게 설정됨
- [ ] 서버에서 알림을 보낼 수 있음
- [ ] (모바일) PWA로 설치됨 (권장)

## 🧪 테스트 시나리오

### 시나리오 1: 앱이 열려있을 때
- ✅ 알림이 즉시 표시되어야 함

### 시나리오 2: 앱이 백그라운드에 있을 때
- ✅ 알림이 표시되어야 함
- ✅ 알림 클릭 시 앱이 포커스되어야 함

### 시나리오 3: 앱이 완전히 종료되었을 때
- ✅ 알림이 표시되어야 함
- ✅ 알림 클릭 시 앱이 열려야 함

### 시나리오 4: 모바일에서 화면이 꺼져있을 때
- ✅ 알림이 표시되어야 함
- ✅ 알림 클릭 시 앱이 열려야 함

## 💡 추가 정보

- Service Worker는 브라우저가 백그라운드에서 실행하는 스크립트입니다
- Push 알림은 서버에서 Service Worker로 전송됩니다
- Service Worker가 활성화되어 있으면 앱이 닫혀도 알림을 받을 수 있습니다
- 모바일에서는 PWA로 설치하면 더 안정적으로 작동합니다

